{% extends "base.html" %}

{% block title %}Glassdoor Job Market Intelligence{% endblock %}

{% block content %}
<!-- Main Content -->
<div class="container-fluid px-3 py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
            <!-- Search Form -->
            <div class="card shadow-lg border-0" style="border-radius: 20px;">
                <div class="card-header border-0 text-center" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-radius: 20px 20px 0 0;">
                    <h3 class="mb-0 py-3">
                        <i class="fas fa-search me-2"></i>Start Your Job Market Analysis
                    </h3>
                </div>
                <div class="card-body p-3 p-md-4 p-lg-5">
                    <form id="scraping-form">
                        <!-- Google Sheets Integration -->
                        <div class="mb-4 p-3 p-md-4" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 15px; color: white;">
                            <h5 class="mb-3">
                                <i class="fas fa-table me-2"></i>Google Sheets Integration
                            </h5>
                            <input type="text" class="form-control form-control-lg" id="sheet_id" name="sheet_id" 
                                   value="1iibXYJ5ZSFZzFIKUyM8d4u3x87FOereMESBfuFW7ZYI"
                                   placeholder="Enter your Google Sheet ID"
                                   style="border-radius: 10px; border: none; font-size: 0.9rem;">
                            <div class="mt-2">
                                <small>Results will be automatically saved to your Google Sheet with professional formatting</small>
                            </div>
                        </div>

                        <!-- Job Search Parameters -->
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <div class="mb-4">
                                    <label for="keyword" class="form-label h6">
                                        <i class="fas fa-briefcase text-primary me-2"></i>Job Title / Keywords
                                    </label>
                                    <input type="text" class="form-control form-control-lg" id="keyword" name="keyword" 
                                           placeholder="e.g., Data Scientist, Software Engineer" value="data analyst" 
                                           required style="border-radius: 10px;">
                                    <div class="form-text">Enter the job title or keywords to search for</div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="mb-4">
                                    <label for="location" class="form-label h6">
                                        <i class="fas fa-map-marker-alt text-success me-2"></i>Location
                                    </label>
                                    <input type="text" class="form-control form-control-lg" id="location" name="location" 
                                           placeholder="e.g., Toronto, New York, Remote" value="Canada" 
                                           required style="border-radius: 10px;">
                                    <div class="form-text">City, state, country, or "Remote"</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="num_pages" class="form-label h6">
                                <i class="fas fa-layer-group text-info me-2"></i>Data Volume
                            </label>
                            <select class="form-select form-select-lg" id="num_pages" name="num_pages" style="border-radius: 10px;">
                                <option value="1">Light Scan (~30 jobs)</option>
                                <option value="2" selected>Standard Scan (~60 jobs)</option>
                                <option value="3">Deep Scan (~90 jobs)</option>
                                <option value="5">Comprehensive (~150 jobs)</option>
                                <option value="10">Market Analysis (~300 jobs)</option>
                            </select>
                            <div class="form-text">More pages provide deeper market insights but take longer to process</div>
                        </div>

                        <!-- Action Button -->
                        <div class="row g-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-lg py-3 w-100" id="start-btn" 
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-weight: bold;">
                                    <i class="fas fa-rocket me-2"></i>Launch Job Market Analysis
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Progress Section -->
            <div id="progress-section" class="card shadow-lg border-0 mt-4" style="display: none; border-radius: 20px;">
                <div class="card-header border-0" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 20px 20px 0 0;">
                    <h5 class="mb-0 text-center py-3" style="color: #333;">
                        <i class="fas fa-cogs me-2"></i>Processing Your Request
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="progress mb-3" style="height: 10px; border-radius: 10px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                    </div>
                    <div id="progress-message" class="text-center">
                        <p class="mb-2">Initializing AI-powered job extraction...</p>
                        <small class="text-muted">Our advanced API technology is gathering market intelligence</small>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Features Section -->
    <div class="row mt-4 mt-md-5 py-3 py-md-5">
        <div class="col-12 text-center mb-4 mb-md-5">
            <h2 class="h3 h-md-2 fw-bold" style="color: #333;">Advanced Features</h2>
            <p class="lead text-muted d-none d-md-block">Powered by cutting-edge API technology</p>
        </div>
        <div class="col-12 col-md-4 mb-4">
            <div class="card h-100 border-0 shadow" style="border-radius: 15px;">
                <div class="card-body text-center p-3 p-md-4">
                    <div class="mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                        <i class="fas fa-robot fa-lg text-white"></i>
                    </div>
                    <h6 class="fw-bold">AI-Powered Extraction</h6>
                    <p class="text-muted small">Advanced GraphQL API technology extracts comprehensive job data with high accuracy.</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4 mb-4">
            <div class="card h-100 border-0 shadow" style="border-radius: 15px;">
                <div class="card-body text-center p-3 p-md-4">
                    <div class="mb-3" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                        <i class="fas fa-chart-line fa-lg text-white"></i>
                    </div>
                    <h6 class="fw-bold">Market Intelligence</h6>
                    <p class="text-muted small">Analyze salary trends, company insights, and market patterns with comprehensive data fields.</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4 mb-4">
            <div class="card h-100 border-0 shadow" style="border-radius: 15px;">
                <div class="card-body text-center p-3 p-md-4">
                    <div class="mb-3" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                        <i class="fas fa-table fa-lg text-white"></i>
                    </div>
                    <h6 class="fw-bold">Instant Export</h6>
                    <p class="text-muted small">Seamlessly export to Google Sheets with professional formatting for immediate analysis.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('scraping-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const startBtn = document.getElementById('start-btn');
    const progressSection = document.getElementById('progress-section');
    
    // Disable form and show progress
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Launching Analysis...';
    progressSection.style.display = 'block';
    
    // Smooth scroll to progress
    progressSection.scrollIntoView({ behavior: 'smooth' });
    
    // Start scraping
    fetch('/start_scraping', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Start polling for progress
            pollProgress();
        } else {
            alert('Error: ' + data.error);
            resetForm();
        }
    })
    .catch(error => {
        alert('Error starting analysis: ' + error);
        resetForm();
    });
});

function pollProgress() {
    fetch('/progress')
        .then(response => response.json())
        .then(data => {
            updateProgress(data);
            
            if (data.status === 'running') {
                // Continue polling
                setTimeout(pollProgress, 2000);
            } else if (data.status === 'completed') {
                showResults(data);
            } else if (data.status === 'error') {
                showError(data.message);
            }
        })
        .catch(error => {
            console.error('Error polling progress:', error);
            setTimeout(pollProgress, 5000); // Retry after 5 seconds
        });
}

function updateProgress(data) {
    const progressBar = document.getElementById('progress-bar');
    const progressMessage = document.getElementById('progress-message');
    
    let percentage = 0;
    if (data.total_pages > 0) {
        percentage = Math.round((data.current_page / data.total_pages) * 100);
    }
    
    progressBar.style.width = percentage + '%';
    progressBar.textContent = percentage + '%';
    
    progressMessage.innerHTML = `
        <p class="mb-2">${data.message}</p>
        <small class="text-muted">Processing page ${data.current_page} of ${data.total_pages}</small>
    `;
}

function showResults(data) {
    // No need to hide results section since it was removed
    
    // Update progress section to show completion
    const progressMessage = document.getElementById('progress-message');
    const progressBar = document.getElementById('progress-bar');
    
    progressBar.style.width = '100%';
    progressBar.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
    
    let message = `✅ Scraping complete! Successfully extracted ${data.job_count} jobs`;
    
    if (data.sheets_url) {
        message += ` • Saved to Google Sheets`;
        progressMessage.innerHTML = `
            <p class="mb-2">${message}</p>
            <div class="mt-3">
                <a href="${data.sheets_url}" target="_blank" class="btn btn-success btn-sm me-2">
                    <i class="fas fa-external-link-alt me-1"></i>Open Google Sheet
                </a>
                <button class="btn btn-primary btn-sm" onclick="location.reload()">
                    <i class="fas fa-redo me-1"></i>New Analysis
                </button>
            </div>
        `;
    } else {
        message += ` • Data processed successfully`;
        progressMessage.innerHTML = `
            <p class="mb-2">${message}</p>
            <div class="mt-3">
                <button class="btn btn-primary btn-sm" onclick="location.reload()">
                    <i class="fas fa-redo me-1"></i>New Analysis
                </button>
            </div>
        `;
    }
    
    resetForm();
}

function showError(message) {
    alert('Analysis error: ' + message);
    resetForm();
}

function resetForm() {
    const startBtn = document.getElementById('start-btn');
    startBtn.disabled = false;
    startBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>Launch Job Market Analysis';
}
</script>
{% endblock %}